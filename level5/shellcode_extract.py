from qiling import Qiling
from qiling.const import QL_VERBOSE

key_hex = "943DF638A81813E2DE6318A507F9A0BA2DBB8A7BA63666D08D11A65EC914D66FF236839F4DCD711A52862955"
encrypted_shellcode = "0FB0354E81FD50E504BF6B1BC20F66167F1A8066014B3FEDA68BAA2D42AE3BE87CE8703035E632223D8AB9DF9769B3426DE484665BC7D5295347073ECFFB29BFC21F36DD284146A36899FFEFE9D0C5E71FDA58ADBCB3924D923FC580D6DFD8FBC3CC3E45C319C0CAF380E54584B3ECA78853EB9F7E7CC921F15D526394DE65F53B18117E4E030A311E57D0D248368A607CE15FFE774F417FC726D32EC09D266144792AAEADC2D391BFBA987ABDED1CE1125379E9A973839CDFC61101D1A94442BD765932E017FC53DCA8EEBC9679DC47185D120A1AE56B54E5CDEE9B5687D5B1E86D8DA957E6E986AB4A7FAAD933DFD07759F8D7CF4152C798BD51A7C2C8355512D4B3B5ABEF3E3B73818E30276B80E2D1CDD714FB48D1E894DDA30A6A2D0417C7507B5552D63BBE7CEAD0A4F7C069BE5765CC61BA671EFC8011390E8143B89AF5734617A31ADD326550AFD23E83B5620D4415FA92B7C0CC70AFF6C2E3330EFF8C901CD16EC0819AE7E50EFA86B5535ACCB38109DF76D1832FCFD80DFFD73B43C2C1B7C7DF05766C887D28EC0FEFF48B12CDFC08DBBD82007CF3958E41CDFDFDEE0F6EA39986973BB3234135F66690A25AEABBFCB0F44DD54814712498C2331186F0F7A1F8140C1CEAD4AB40F5B79A000A4072466B23B30B145DF0A35E2B0E55F6BBDC1CE99FA674C51C291D59049651C2968BD431D52CE095BF4BDCE8524FB077BFFDBF7CBAE320D27517FEF034E43EBBD756E625E80BA71C5BF2EB244570629D74BD8EE5C4FD730CA1A104B0E43F41C2D9BA73D2D16A8C37BC2BEE37ECE01FA3F03A40BDE70CCD34E7F0B797CC5B524F80ED4F1E5B047E62D7A0A3003D5DCD850D035AC00E634419FDC22B483FE81D4EF614FFAC75A2F4185532503BD4DF08C27F5B9CD2D8BBC42311FE9D049948AF36F1AFF565ED30B6E61113659BF6978601E773A6B0DBF949F31C947E98FE52BC6B6D87592D1B6EFFAF2D5D5C6DAA71848A91BEB205B4369F981BAC6CC043736AB06B5ECB903495C283039B4792E8F5E0B6DEEAC0645489C90BFA02176B92153643141846C7242CAA43A45F04E08D6E653F3318F31463F6D7BECFDB37624E2609FD627A90DD6111E6ABCDEEE373036B143B130B576487428A686426B80D1F6032089955CFAF17FD358706CA2241428D646DE3B739455EA2DE7B9B9C52F54681217DEB59620AD1A662DA5E9F8A082346B0EF91B8DCE971D553258845A52D3F683A07D16816F2A6C120DC9411E437B7D924752BB4E675594A83FE0BD7164D669A04462BA96CC63D69DB7D241A48E11FDF630529F60F97A0E494E6FE520E3878AEB81F6B804F28F5DAA99ECE0049D0132200CB6C6E454D253E5A999AB02DE9B724EB905BAAF523269A3ACD5CD0FE6FCBEF31D6F261A962FE0A461C87899CD3A0BBAE2EB2C79BC0B29D17AAD5AC93D6C8C826DB14A8F20C19E030D0D5478037C52AA92B0595931496D505E7DB8F7107214C888F0E1BCC63219C4982D7B81FEBBC6F3C0A2822D708D7B078B1BB202FEA182D86B6E6E2F8C20C0F94E18DE818951F540A2358CEA4CC237F5E5CA94EF871A794A8556A689C5956F964BD55A65A5003C3BD18E71A3A1B289867A7C502991CBD6E8C398EAA97C0A59BEDCA29B70D318BFA20F3935E4CBB0E2C4067B4E2DFA0C465DE7DEE91EAA5A3CA6331D3F2D8207BF0614EFA76A6C212219E56A1D5415B838A1CFEFB93F2E22539B62F16C977179C162DA22713CF1A8274518B168F796449BAF5DBDCCC281C23E6CB3C5C48071B9637652CA29AC22FC6E81A563153CFEC1B6CFCEBBC5019974E1416CB97F4ACD8827DF34702F4DA695E52FB30BC8E302C10F52FD1EC0D133B78CC7EB59C434C3627F90CDBC6B84725D1ED85A41CDB1B3E1A8E85BC113C6C396B347F9ABAA57B97C11683D3DCB6E1CE9CE83DD56392BACFE895A36C239860963A7A3B61A0602BA4268BB67A886863690A2847FBB85821833598B347447ABB78212D3BD7F60345D38FE4D1A2F429AA2B08D8B4CD364B3E41BDFEF3B67B1815A080B12703132691DC0A1CDC8FB80C8696CD86F9A8D819697BD1CE8D5951DC7DAAAFA42016173E00A2D5CDF74D423A1974B49A9F8DBC0601C3B566A73BBD10856801DE718A71105013FEDF7E23DA3C0B2F7CF2E0F471F3D601D0A66DBEFA0ADA08E96386EE0CB7E5EAC965204B53009DB3AD0A93835F24118D0DF48BDFA5618D08702E175990A189E463B4D2B51285CA48C72D0B1BD286CC604C33FACC174AEA16E808732AB528B5028096C32EAD62877C767FAA57817E170274C0980CD063EEE529A85F2E374BAE6EBEE7CF26733EEDEC18A533B8A4646127F84BE1666888B2E9872440CB0EAFA244C81008D41E2BDE095C94DB4630C03C6C0E8A6FB915CEE84BAA2DCE72F6B7D2F4A94BB14E63DD204B1FED12A1DF7425A9B01BD7739EB830CB8A998DDE210DB89F2703E21FDEB91E1FF630A71099605AAEB75205F07F1C7E90474638A6C3411E9556A34E672440A4BF05C182A804FCAE1ECA75A3C53D4AFF3FFEED7165E5B8C57F44865670CFA7B12A6A63ED4854530D6CF2A211B11E85D36743235780C9B6501026A791356F4814D3408F53E73256433E66409939121C3FDE5CA6199112ECC6198911F69B66EB99FDDDCD562CBC4CD0DAC4A305780A948BCF35EF8A2F5351466175F55BCF91FFC605762B1DC1AA17E0EC2DEB47920A94589ADEF63575DA48FE2E98680DC63976F3DC0BC91288C9A417184F68D71FBE8CFF4D9E67B9E0450E726BB179338E6C3EC51F268D7694BBD03B0B68FB33DDCB4C059B52FBA6764520DF07CCD3F7178C84C0C6F7D12FA46438B243CBC78D8DE96044438B42D7360062B4A9961F9C31D492E0CEE84764D0553E98057D3D95C49B05E604A03F285AEAEF16BB7661446C5B2E2D5637ADAFC0310A44ABC9E67B8F836F780026C98858BA8DA0ED899E01A5DA26B2D8BF9CCEE984D916803C95AD604DCDF116304B7E827CA7C7F9B7B3A835D658BEA901525DDF12D1B4939CF9F11795D0F9E76190C4D4D266988E365EAD38FE51FB074844C8FB6DBDDFEE225092AA2B8623FABAC39CDDB6E2062F0385E1F2D838E7292C1671F0AEE7F3DB5CDF9C8E385CD5AB03A580810ACE75355C3A3373F3268A1DA807CBB3801AC2C54948D8CA7AC1C5F25210AD4708498DF115A11D6E8A9931C479464F785F87B79BD4B3A0201A2DE0594D96FC7A4AE03AFB857A631F00B722B107E754C38BDB1EBD7A1D01E194CBCEB24DDEC89CD6448FA930E7BE5C6F59A13A0F9C9352BF3F03DF6F0AE0F868A56AA26E0F3569F8FD376E816ADA77803CDEE0C7B9AED820B3A5A2847AFF1FBE4B435281C2D11202A5B849442CA588C607F5EA1DBBB66852E84AD3D9F60A97DFA4D1060BCDA6305B2B8744445D69D3ACB8966F28087D2E3D72B8396DCBB1C8A753B9989A9CA97C9DB74BA74968A9AD604E23A65F20B15D772F02101A90633B481F2ACC6B1CCA8B54EE5B4D5DFA9A8AEC996D88E5F1C94AB8D521780BB1B90F0A2290F7E25E976F45D6EB4E3AFF89235893BA9837FC783D88F4F3BED8467DF5D633C590FD8080A3A2DBE9B0A3DFE56F154D300EA817B202845EAC06F2C6D7A2C0CE9FBB504C4A4B1583B269C48CD993B4D0762CB836A1A1BFBF614E8F3A9C7139E336CF4C7EE07604B76646E8BD57B67C79C5C4A9D53B27D2C74D84E1ACDC942B1A02B56DFE15BDE63161493B79D616A1E5AA339E3DAE4F1E627390E8694B265BFD8FDAA83DB379B8F395B6F37B3F98D4D9DBFB23024BD45EDC564EC7968961E1EBC5CDE461E19191E39E52BC7DC07EC9AFBA567D849B0F4B91C10604A847FA079DDFFA93A9684D3BC0CB48CD5BFDBD21B5E51773623AFF20B4BC802B2413738AC0A6C44F85A5844614E9CA292F5C6B2A5818D12A066AA2F97E446C28C46A0510A4E1849DB08263B2D8F1CD4CCE23A60BB5D590B6813DE8D503E19057C72DD6683B1CCFC12112830D50BB47AE054125B9F5E98B3BA7E2E74435D2B0BBAE15462C261ACC87BAFD688CE3C80C80D7B3E8D8F92F5C8D7129DA8EAD6038B6BE73EBB7ABA263EB5E17545551A745025B67E365C9D6918B9B8189B940D8C33DC9F5922403A39DD2466346094CB824E0C4A2F4E551ABC8C12FB2270D61B0F92D0EAC9E7436F9C505EE90C49361D95ED8A4E52360D05679CC2712996B19E488C18CCC617CBEA98C6B6B8A7A395EB1C071C6F749E45C41AB64D10C7E8AC05C0B51A1757AB60780BACE893FF709825C290F332044528F0D180496248EF44A1FCCF164DC50DF1304AF12B4371EAAEB9C1401BD553E99F92557EE2AC20F3877DD726E3F99379B69E57A53B05D2653AA764C26D1F2F5FEEC74F7EBC0B36E492DA0F1F0DB6BE48C3ADBD2CEAB54A3305A521D2EEF1409DEC3675E7B550639AC90A6EF532164F2F54EE1A1388FB6323A0FC7EB05383E9EABEC54B4268D4C501A6D8136FB696EBA3AB01A80507904E1D2FDC7304DE70C17C228923D62F8EE4C7331C52D560ECBA5E57ED75C884C881BF3A6AF941968249FCB1BCBFECEBD9950D5DEA6BA5FD900F0F33DE57F000A10061118732EF2E09D27630579395119AFD494D0A5E9705F7FCD9E3303E39751D3A3DB4C2C9B41ECF87C68B635CBF44C68CDD60149D962FA606E4F8EA88650DDAFAA0E02D472A0E7618BD23227AB3F19E5204A29B3242A5CC95E4429B9F915E0A1D67163675E270519A4B9861447B4F8032A466E8874A27DE994FE609C83BD64C64C19D2972CB5D8C436C53746E5AB472656AEAF93F3C08ABFF1D53BEF412DE604007445E1FBD38A9A7FB1E1B590B4B45E892C337B4CA7B35C48424468478AC8FD7AD941B170F6D53749CC555845BDA354FAF2ED471C47E639D99DF85260513344D6270E1174D4470465064C2F0E93DDAFAC20AC20DF94506746B12A4E2D5A94B64D534C2DE815EC0FB295139CF2AA07C8512F32646E9E3EE766586DD553F0B6F9FF6C998B41DC1146D6C9C4C7AA46717530656445D1996B69D653ADD37643280657154789CDD5C64A8A1F2F92474B5229C3F8908EA50AF69ECEC580A40F76601DBEE6E89375369C206862B52AB9A022983B620B58B6E13DDFD6EA55ACA29A196FE07761C7D45229B3699555E9204A0E97E4CCC043A87244CB34D20406E44832D989BB121F96E949DF1FD8819DA6003E39885ACE466D1061F4930019000C15AD69E9183800CD641D61008BDAC417FE60B4D7417E4974C394C10B8E842460D4F01C253BAAB59E8C57C7FB09F3187ED6D253C690888F031A5BFDDDC4318B42A948C3ACA95F17C8EBD9507E17890BEBACDABEEC1B2D9525FC5914D3D4A7B1DB27B1737BDE7012069C82C4408AB340C99CD2F84A0A3EC4EE95A0C7470B1B7FBD62A33B9D38CCF718D0263CB34C1ED8BA5B72BF72227DFC97046E57DB2CF804C3A137DF9B78F7606A5169B7B68AAF438EB30DFD21716EEA96A54B6D5D7DDE8B6B4B9F8500473713C3607BA97311B95D521A60C45FF68F0DBC0019C3CA8A0E1C824CBC0733B2B9B67CE48A03B23E3D03B2D60A24D171FE13AF26A44A7BE4EC4A9D7ECB9AC8781133A013725FAA6511001F50EB8D79AA4E052B669C086973EF426D66AF0C4D3686A0D12E5C055A48FEFEF791"

binary_path = "sshcontainer/usr/lib/x86_64-linux-gnu/liblzma.so.5.4.1"  
rootfs_path = "sshcontainer"  

ql = Qiling([binary_path], rootfs_path, verbose=QL_VERBOSE.DISASM)

stack_size = 0x5000  
stack_address = ql.mem.map_anywhere(
    stack_size, perms=3
)  # Arbitrary address for the stack base

baseaddr = ql.loader.images[0].base
chachainit = baseaddr + 0x00000000000093F0
chachainitend = baseaddr + 0x0000000000009515

chachaxor = baseaddr + 0x0000000000009520
chachaxorend = baseaddr + 0x0000000000009810

key_addr = stack_address + 0x1000
ql.mem.write(key_addr, bytes.fromhex(key_hex))

ql.arch.regs.rdi = stack_address   # ctx
ql.arch.regs.rsi = key_addr   # key
ql.arch.regs.rdx = key_addr + 0x20   # nonce
ql.arch.regs.rcx = 0 # counter

ql.run(begin=chachainit, end=chachainitend) # run chachainit

shellcode_addr = stack_address + 0x2000
ql.mem.write(shellcode_addr, bytes.fromhex(encrypted_shellcode))

ql.arch.regs.rdi = stack_address   # ctx
ql.arch.regs.rsi = shellcode_addr # buffer
ql.arch.regs.rdx = 0xf96   # buf_size

try:
    ql.run(begin=chachaxor, end=chachaxorend) # run chachaxor against the shellcode
except Exception as e:
    # will error due to `retn` somehow but no need to care
    print(e)
    pass

decrypted_shellcode = ql.mem.read(shellcode_addr, 0xf96)  
print(f"decrypted shellcode: {decrypted_shellcode.hex()}")

# # Write the byte data to the file
with open("shellcode.bin", 'wb') as file:
    file.write(decrypted_shellcode)

# Clean up after execution
ql.emu_stop()
